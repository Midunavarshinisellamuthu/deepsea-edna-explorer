{% extends "base.html" %}

{% block title %}DeepSea eDNA Explorer - My Collaborations{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}" class="text-primary"><i class="fas fa-home me-1"></i>Dashboard</a></li>
                <li class="breadcrumb-item active" aria-current="page"><i class="fas fa-users me-1"></i>My Collaborations</li>
            </ol>
        </nav>
    </div>
</div>

<div class="row align-items-center mb-4">
    <div class="col-md-8">
        <h1 class="display-5 fw-bold text-primary"><i class="fas fa-handshake me-2"></i>My Collaborations</h1>
        <p class="lead">Projects where you are a collaborator.</p>
        <div class="ocean-divider mb-4"></div>
    </div>
</div>

<!-- Collaborative Projects -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card ocean-card">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h4 class="mb-0"><i class="fas fa-project-diagram me-2"></i>Collaborative Projects</h4>
                <div class="input-group" style="max-width: 300px;">
                    <input type="text" class="form-control ocean-input" placeholder="Search projects" id="projectSearch">
                    <button class="btn btn-light" type="button" id="searchProjectBtn">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
            </div>
            <div class="card-body">
                {% if collaborative_projects %}
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead>
                            <tr>
                                <th>Project</th>
                                <th>Owner</th>
                                <th>Created</th>
                                <th>Samples</th>
                                <th>Analyses</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for project in collaborative_projects %}
                            <tr>
                                <td>
                                    <a href="{{ url_for('project_detail', project_id=project.id) }}" class="text-decoration-none">
                                        <div class="d-flex align-items-center">
                                            <div class="project-icon me-2 bg-primary text-white">
                                                <i class="fas fa-project-diagram"></i>
                                            </div>
                                            <div>
                                                <h6 class="mb-0">{{ project.title }}</h6>
                                                <small class="text-muted">{{ project.description|truncate(50) }}</small>
                                            </div>
                                        </div>
                                    </a>
                                </td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="avatar me-2">
                                            {% if project.owner.profile_picture %}
                                            <img src="{{ project.owner.profile_picture }}" alt="{{ project.owner.name }}" class="rounded-circle" width="32" height="32">
                                            {% else %}
                                            <div class="avatar-placeholder bg-secondary text-white rounded-circle">
                                                {{ project.owner.name[:1] }}
                                            </div>
                                            {% endif %}
                                        </div>
                                        <div>{{ project.owner.name }}</div>
                                    </div>
                                </td>
                                <td>{{ project.created_at|datetimeformat }}</td>
                                <td>{{ project.samples|length }}</td>
                                <td>
                                    {% set analysis_count = 0 %}
                                    {% for sample in project.samples %}
                                        {% set analysis_count = analysis_count + sample.analyses|length %}
                                    {% endfor %}
                                    {{ analysis_count }}
                                </td>
                                <td>
                                    <div class="d-flex">
                                        <a href="{{ url_for('project_detail', project_id=project.id) }}" class="btn btn-sm btn-primary me-1" title="View Project">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        <a href="#" class="btn btn-sm btn-info me-1" title="View Samples">
                                            <i class="fas fa-vial"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i> You are not collaborating on any projects yet.
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}
                                            <img src="{{ collaborator.user.profile_picture }}" alt="{{ collaborator.user.full_name }}" class="rounded-circle" width="40" height="40">
                                        </div>
                                        <div>
                                            <div class="fw-bold">{{ collaborator.user.full_name }}</div>
                                            <div class="small text-muted">{{ collaborator.user.institution }}</div>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    {% if collaborator.is_owner %}
                                    <span class="badge bg-dark">Owner</span>
                                    {% elif collaborator.role == 'admin' %}
                                    <span class="badge bg-danger">Admin</span>
                                    {% elif collaborator.role == 'editor' %}
                                    <span class="badge bg-warning">Editor</span>
                                    {% else %}
                                    <span class="badge bg-info">Viewer</span>
                                    {% endif %}
                                </td>
                                <td>{{ collaborator.joined_at|datetimeformat }}</td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="me-2">{{ collaborator.contributions }}</div>
                                        <div class="progress flex-grow-1" style="height: 6px;">
                                            <div class="progress-bar" role="progressbar" style="width: {{ (collaborator.contributions / project.total_contributions * 100)|round }}%;" aria-valuenow="{{ collaborator.contributions }}" aria-valuemin="0" aria-valuemax="{{ project.total_contributions }}"></div>
                                        </div>
                                    </div>
                                </td>
                                <td>{{ collaborator.last_active|timeago }}</td>
                                <td>
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="collaboratorDropdown{{ collaborator.id }}" data-bs-toggle="dropdown" aria-expanded="false">
                                            Actions
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="collaboratorDropdown{{ collaborator.id }}">
                                            <li><a class="dropdown-item" href="{{ url_for('user_profile', username=collaborator.user.username) }}">
                                                <i class="fas fa-user me-2"></i>View Profile
                                            </a></li>
                                            {% if current_user.id == project.owner_id or collaborator.role == 'admin' %}
                                            <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#changeRoleModal{{ collaborator.id }}">
                                                <i class="fas fa-user-tag me-2"></i>Change Role
                                            </a></li>
                                            <li><hr class="dropdown-divider"></li>
                                            <li><a class="dropdown-item text-danger" href="#" data-bs-toggle="modal" data-bs-target="#removeCollaboratorModal{{ collaborator.id }}">
                                                <i class="fas fa-user-minus me-2"></i>Remove
                                            </a></li>
                                            {% endif %}
                                        </ul>
                                    </div>
                                </td>
                            </tr>
                            
                            <!-- Change Role Modal -->
                            <div class="modal fade" id="changeRoleModal{{ collaborator.id }}" tabindex="-1" aria-labelledby="changeRoleModalLabel{{ collaborator.id }}" aria-hidden="true">
                                <div class="modal-dialog">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title" id="changeRoleModalLabel{{ collaborator.id }}">Change Role for {{ collaborator.user.full_name }}</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                        </div>
                                        <div class="modal-body">
                                            <form method="POST" action="{{ url_for('change_collaborator_role', project_id=project.id, collaborator_id=collaborator.id) }}">
                                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                                <div class="mb-3">
                                                    <label for="roleSelect{{ collaborator.id }}" class="form-label">Select Role</label>
                                                    <select class="form-select" id="roleSelect{{ collaborator.id }}" name="role">
                                                        <option value="admin" {% if collaborator.role == 'admin' %}selected{% endif %}>Admin (Full access)</option>
                                                        <option value="editor" {% if collaborator.role == 'editor' %}selected{% endif %}>Editor (Can edit but not delete)</option>
                                                        <option value="viewer" {% if collaborator.role == 'viewer' %}selected{% endif %}>Viewer (Read-only access)</option>
                                                    </select>
                                                </div>
                                                <div class="mb-3">
                                                    <label for="roleNotes{{ collaborator.id }}" class="form-label">Notes (Optional)</label>
                                                    <textarea class="form-control" id="roleNotes{{ collaborator.id }}" name="notes" rows="2" placeholder="Add a note about this role change"></textarea>
                                                </div>
                                                <div class="form-check mb-3">
                                                    <input class="form-check-input" type="checkbox" id="notifyUser{{ collaborator.id }}" name="notify_user" checked>
                                                    <label class="form-check-label" for="notifyUser{{ collaborator.id }}">
                                                        Notify user about role change
                                                    </label>
                                                </div>
                                                <div class="d-flex justify-content-end">
                                                    <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">Cancel</button>
                                                    <button type="submit" class="btn btn-primary">Change Role</button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Remove Collaborator Modal -->
                            <div class="modal fade" id="removeCollaboratorModal{{ collaborator.id }}" tabindex="-1" aria-labelledby="removeCollaboratorModalLabel{{ collaborator.id }}" aria-hidden="true">
                                <div class="modal-dialog">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title" id="removeCollaboratorModalLabel{{ collaborator.id }}">Remove Collaborator</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                        </div>
                                        <div class="modal-body">
                                            <p>Are you sure you want to remove <strong>{{ collaborator.user.full_name }}</strong> from this project?</p>
                                            <p class="text-danger">This action cannot be undone.</p>
                                            
                                            <form method="POST" action="{{ url_for('remove_collaborator', project_id=project.id, collaborator_id=collaborator.id) }}">
                                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                                <div class="form-check mb-3">
                                                    <input class="form-check-input" type="checkbox" id="notifyRemoval{{ collaborator.id }}" name="notify_user" checked>
                                                    <label class="form-check-label" for="notifyRemoval{{ collaborator.id }}">
                                                        Notify user about removal
                                                    </label>
                                                </div>
                                                <div class="mb-3">
                                                    <label for="removalReason{{ collaborator.id }}" class="form-label">Reason (Optional)</label>
                                                    <textarea class="form-control" id="removalReason{{ collaborator.id }}" name="reason" rows="2" placeholder="Provide a reason for removing this collaborator"></textarea>
                                                </div>
                                                <div class="d-flex justify-content-end">
                                                    <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">Cancel</button>
                                                    <button type="submit" class="btn btn-danger">Remove Collaborator</button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Pending Invitations -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Pending Invitations</h5>
            </div>
            <div class="card-body">
                {% if pending_invitations %}
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead>
                            <tr>
                                <th>Email</th>
                                <th>Role</th>
                                <th>Invited By</th>
                                <th>Invited On</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for invitation in pending_invitations %}
                            <tr>
                                <td>{{ invitation.email }}</td>
                                <td>
                                    {% if invitation.role == 'admin' %}
                                    <span class="badge bg-danger">Admin</span>
                                    {% elif invitation.role == 'editor' %}
                                    <span class="badge bg-warning">Editor</span>
                                    {% else %}
                                    <span class="badge bg-info">Viewer</span>
                                    {% endif %}
                                </td>
                                <td>{{ invitation.invited_by.full_name }}</td>
                                <td>{{ invitation.created_at|datetimeformat }}</td>
                                <td>
                                    {% if invitation.status == 'pending' %}
                                    <span class="badge bg-warning">Pending</span>
                                    {% elif invitation.status == 'expired' %}
                                    <span class="badge bg-danger">Expired</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group">
                                        <button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#resendInvitationModal{{ invitation.id }}">
                                            <i class="fas fa-paper-plane me-1"></i>Resend
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-danger" data-bs-toggle="modal" data-bs-target="#cancelInvitationModal{{ invitation.id }}">
                                            <i class="fas fa-times me-1"></i>Cancel
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            
                            <!-- Resend Invitation Modal -->
                            <div class="modal fade" id="resendInvitationModal{{ invitation.id }}" tabindex="-1" aria-labelledby="resendInvitationModalLabel{{ invitation.id }}" aria-hidden="true">
                                <div class="modal-dialog">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title" id="resendInvitationModalLabel{{ invitation.id }}">Resend Invitation</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                        </div>
                                        <div class="modal-body">
                                            <p>Resend invitation to <strong>{{ invitation.email }}</strong>?</p>
                                            <form method="POST" action="{{ url_for('resend_invitation', invitation_id=invitation.id) }}">
                                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                                <div class="mb-3">
                                                    <label for="customMessage{{ invitation.id }}" class="form-label">Custom Message (Optional)</label>
                                                    <textarea class="form-control" id="customMessage{{ invitation.id }}" name="custom_message" rows="3" placeholder="Add a personal message to the invitation email"></textarea>
                                                </div>
                                                <div class="d-flex justify-content-end">
                                                    <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">Cancel</button>
                                                    <button type="submit" class="btn btn-primary">Resend Invitation</button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Cancel Invitation Modal -->
                            <div class="modal fade" id="cancelInvitationModal{{ invitation.id }}" tabindex="-1" aria-labelledby="cancelInvitationModalLabel{{ invitation.id }}" aria-hidden="true">
                                <div class="modal-dialog">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title" id="cancelInvitationModalLabel{{ invitation.id }}">Cancel Invitation</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                        </div>
                                        <div class="modal-body">
                                            <p>Are you sure you want to cancel the invitation to <strong>{{ invitation.email }}</strong>?</p>
                                            <p class="text-danger">This action cannot be undone.</p>
                                            <form method="POST" action="{{ url_for('cancel_invitation', invitation_id=invitation.id) }}">
                                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                                <div class="d-flex justify-content-end">
                                                    <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">Back</button>
                                                    <button type="submit" class="btn btn-danger">Cancel Invitation</button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="alert alert-info mb-0">
                    <i class="fas fa-info-circle me-2"></i>No pending invitations.
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Sharing Options -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Sharing Options</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Project Visibility</h6>
                        <p class="text-muted small">Control who can see your project and its data.</p>
                        
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="radio" name="projectVisibility" id="visibilityPrivate" {% if not project.is_public %}checked{% endif %}>
                            <label class="form-check-label" for="visibilityPrivate">
                                <i class="fas fa-lock me-2"></i><strong>Private</strong> - Only you and your collaborators can access
                            </label>
                        </div>
                        
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="radio" name="projectVisibility" id="visibilityPublic" {% if project.is_public %}checked{% endif %}>
                            <label class="form-check-label" for="visibilityPublic">
                                <i class="fas fa-globe me-2"></i><strong>Public</strong> - Anyone can view (but not edit)
                            </label>
                        </div>
                        
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="radio" name="projectVisibility" id="visibilityLink" {% if project.is_link_shared %}checked{% endif %}>
                            <label class="form-check-label" for="visibilityLink">
                                <i class="fas fa-link me-2"></i><strong>Anyone with the link</strong> - Only people with the link can view
                            </label>
                        </div>
                        
                        <button type="button" class="btn btn-primary" id="saveVisibilityBtn">
                            <i class="fas fa-save me-1"></i>Save Visibility Settings
                        </button>
                    </div>
                    
                    <div class="col-md-6">
                        <h6>Share Link</h6>
                        <p class="text-muted small">Share this link with others to give them access to your project.</p>
                        
                        <div class="input-group mb-3">
                            <input type="text" class="form-control" value="{{ project_share_link }}" id="shareLink" readonly>
                            <button class="btn btn-outline-secondary" type="button" id="copyLinkBtn">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                        
                        <div class="d-flex justify-content-between mb-3">
                            <button type="button" class="btn btn-outline-primary" id="generateNewLinkBtn">
                                <i class="fas fa-sync-alt me-1"></i>Generate New Link
                            </button>
                            
                            <div class="dropdown">
                                <button class="btn btn-outline-primary dropdown-toggle" type="button" id="shareDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="fas fa-share-alt me-1"></i>Share via
                                </button>
                                <ul class="dropdown-menu" aria-labelledby="shareDropdown">
                                    <li><a class="dropdown-item" href="mailto:?subject=Check out my DeepSea eDNA project&body=I'd like to share my DeepSea eDNA Explorer project with you: {{ project_share_link }}">
                                        <i class="fas fa-envelope me-2"></i>Email
                                    </a></li>
                                    <li><a class="dropdown-item" href="https://twitter.com/intent/tweet?text=Check out my DeepSea eDNA Explorer project: {{ project_share_link }}" target="_blank">
                                        <i class="fab fa-twitter me-2"></i>Twitter
                                    </a></li>
                                    <li><a class="dropdown-item" href="https://www.linkedin.com/sharing/share-offsite/?url={{ project_share_link }}" target="_blank">
                                        <i class="fab fa-linkedin me-2"></i>LinkedIn
                                    </a></li>
                                </ul>
                            </div>
                        </div>
                        
                        <h6 class="mt-4">Link Settings</h6>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="linkExpiration" {% if project.link_expiration %}checked{% endif %}>
                            <label class="form-check-label" for="linkExpiration">
                                Set link expiration
                            </label>
                        </div>
                        
                        <div class="mb-3" id="expirationDateContainer" {% if not project.link_expiration %}style="display: none;"{% endif %}>
                            <input type="date" class="form-control" id="expirationDate" value="{{ project.link_expiration_date }}">
                        </div>
                        
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="requirePassword" {% if project.link_password %}checked{% endif %}>
                            <label class="form-check-label" for="requirePassword">
                                Require password
                            </label>
                        </div>
                        
                        <div class="mb-3" id="passwordContainer" {% if not project.link_password %}style="display: none;"{% endif %}>
                            <input type="password" class="form-control" id="linkPassword" placeholder="Enter password" value="{{ project.link_password }}">
                        </div>
                        
                        <button type="button" class="btn btn-primary" id="saveLinkSettingsBtn">
                            <i class="fas fa-save me-1"></i>Save Link Settings
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Export & Citation -->
<div class="row mb-4">
    <div class="col-md-6 mb-4 mb-md-0">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0">Export Project</h5>
            </div>
            <div class="card-body">
                <p class="card-text">Export your project data in various formats for use in other applications or for archiving.</p>
                
                <div class="list-group mb-3">
                    <a href="{{ url_for('export_project', project_id=project.id, format='json') }}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas fa-file-code me-2"></i>JSON Format
                            <small class="d-block text-muted">Complete project data in JSON format</small>
                        </div>
                        <span class="badge bg-primary rounded-pill">Download</span>
                    </a>
                    <a href="{{ url_for('export_project', project_id=project.id, format='csv') }}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas fa-file-csv me-2"></i>CSV Format
                            <small class="d-block text-muted">Tabular data in CSV format</small>
                        </div>
                        <span class="badge bg-primary rounded-pill">Download</span>
                    </a>
                    <a href="{{ url_for('export_project', project_id=project.id, format='biom') }}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas fa-file-alt me-2"></i>BIOM Format
                            <small class="d-block text-muted">Biological Observation Matrix format</small>
                        </div>
                        <span class="badge bg-primary rounded-pill">Download</span>
                    </a>
                </div>
                
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="includeRawData">
                    <label class="form-check-label" for="includeRawData">
                        Include raw sequence data
                    </label>
                </div>
                
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="includeAnalysisResults" checked>
                    <label class="form-check-label" for="includeAnalysisResults">
                        Include analysis results
                    </label>
                </div>
                
                <button type="button" class="btn btn-primary" id="customExportBtn" data-bs-toggle="modal" data-bs-target="#customExportModal">
                    <i class="fas fa-cog me-1"></i>Custom Export
                </button>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0">Citation & Publication</h5>
            </div>
            <div class="card-body">
                <p class="card-text">Use these citation formats when referencing this project in publications.</p>
                
                <div class="mb-3">
                    <label for="citationText" class="form-label">Citation Text</label>
                    <textarea class="form-control" id="citationText" rows="4" readonly>{{ project.owner.last_name }}, {{ project.owner.first_name[0] }}. et al. ({{ project.created_at.year }}). {{ project.title }}. DeepSea eDNA Explorer. https://deepseaedna.org/projects/{{ project.id }}</textarea>
                    <div class="d-flex justify-content-end mt-2">
                        <button type="button" class="btn btn-sm btn-outline-primary" id="copyCitationBtn">
                            <i class="fas fa-copy me-1"></i>Copy
                        </button>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Export Citation</label>
                    <div class="d-flex flex-wrap gap-2">
                        <a href="{{ url_for('export_citation', project_id=project.id, format='bibtex') }}" class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-file-download me-1"></i>BibTeX
                        </a>
                        <a href="{{ url_for('export_citation', project_id=project.id, format='ris') }}" class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-file-download me-1"></i>RIS
                        </a>
                        <a href="{{ url_for('export_citation', project_id=project.id, format='endnote') }}" class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-file-download me-1"></i>EndNote
                        </a>
                    </div>
                </div>
                
                <hr>
                
                <h6>Publication Status</h6>
                <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" id="isPublished" {% if project.is_published %}checked{% endif %}>
                    <label class="form-check-label" for="isPublished">
                        This project has been published
                    </label>
                </div>
                
                <div id="publicationDetailsContainer" {% if not project.is_published %}style="display: none;"{% endif %}>
                    <div class="mb-3">
                        <label for="publicationDOI" class="form-label">DOI</label>
                        <input type="text" class="form-control" id="publicationDOI" placeholder="e.g., 10.1038/s41586-020-2649-2" value="{{ project.publication_doi }}">
                    </div>
                    
                    <div class="mb-3">
                        <label for="publicationURL" class="form-label">Publication URL</label>
                        <input type="url" class="form-control" id="publicationURL" placeholder="https://journal.org/article" value="{{ project.publication_url }}">
                    </div>
                    
                    <button type="button" class="btn btn-primary" id="savePublicationBtn">
                        <i class="fas fa-save me-1"></i>Save Publication Info
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Activity Log -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Collaboration Activity</h5>
                <button type="button" class="btn btn-sm btn-outline-secondary" id="exportActivityBtn">
                    <i class="fas fa-download me-1"></i>Export Log
                </button>
            </div>
            <div class="card-body">
                <div class="timeline">
                    {% for activity in collaboration_activities %}
                    <div class="timeline-item">
                        <div class="timeline-marker {% if activity.type == 'join' %}bg-success{% elif activity.type == 'leave' %}bg-danger{% elif activity.type == 'role_change' %}bg-warning{% elif activity.type == 'comment' %}bg-info{% else %}bg-primary{% endif %}">
                            {% if activity.type == 'join' %}
                            <i class="fas fa-user-plus"></i>
                            {% elif activity.type == 'leave' %}
                            <i class="fas fa-user-minus"></i>
                            {% elif activity.type == 'role_change' %}
                            <i class="fas fa-user-tag"></i>
                            {% elif activity.type == 'comment' %}
                            <i class="fas fa-comment"></i>
                            {% elif activity.type == 'edit' %}
                            <i class="fas fa-edit"></i>
                            {% elif activity.type == 'upload' %}
                            <i class="fas fa-upload"></i>
                            {% elif activity.type == 'analysis' %}
                            <i class="fas fa-chart-bar"></i>
                            {% else %}
                            <i class="fas fa-info-circle"></i>
                            {% endif %}
                        </div>
                        <div class="timeline-content">
                            <div class="d-flex justify-content-between">
                                <h6 class="mb-1">{{ activity.user.full_name }}</h6>
                                <small class="text-muted">{{ activity.timestamp|timeago }}</small>
                            </div>
                            <p class="mb-0">{{ activity.description }}</p>
                            {% if activity.details %}
                            <small class="text-muted">{{ activity.details }}</small>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                {% if collaboration_activities|length >= 10 %}
                <div class="text-center mt-3">
                    <button type="button" class="btn btn-outline-primary" id="loadMoreActivityBtn">
                        <i class="fas fa-plus me-1"></i>Load More
                    </button>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Invite Collaborators Modal -->
<div class="modal fade" id="inviteCollaboratorsModal" tabindex="-1" aria-labelledby="inviteCollaboratorsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="inviteCollaboratorsModalLabel">Invite Collaborators</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="inviteCollaboratorsForm">
                    <div class="mb-3">
                        <label for="inviteEmails" class="form-label">Email Addresses</label>
                        <textarea class="form-control" id="inviteEmails" rows="3" placeholder="Enter email addresses separated by commas"></textarea>
                        <div class="form-text">You can invite multiple collaborators by separating email addresses with commas.</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="inviteRole" class="form-label">Role</label>
                        <select class="form-select" id="inviteRole">
                            <option value="viewer">Viewer (Read-only access)</option>
                            <option value="editor">Editor (Can edit but not delete)</option>
                            <option value="admin">Admin (Full access)</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="inviteMessage" class="form-label">Personal Message (Optional)</label>
                        <textarea class="form-control" id="inviteMessage" rows="3" placeholder="Add a personal message to your invitation"></textarea>
                    </div>
                    
                    <hr>
                    
                    <h6>Or invite from your contacts</h6>
                    <div class="mb-3">
                        <input type="text" class="form-control" id="contactSearch" placeholder="Search your contacts">
                    </div>
                    
                    <div class="row mb-3" id="contactsList">
                        {% for contact in user_contacts %}
                        <div class="col-md-6 mb-2">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="{{ contact.email }}" id="contact{{ contact.id }}">
                                <label class="form-check-label d-flex align-items-center" for="contact{{ contact.id }}">
                                    <img src="{{ contact.profile_picture }}" alt="{{ contact.full_name }}" class="rounded-circle me-2" width="30" height="30">
                                    <div>
                                        <div>{{ contact.full_name }}</div>
                                        <small class="text-muted">{{ contact.email }}</small>
                                    </div>
                                </label>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="sendInvitationsBtn">
                    <i class="fas fa-paper-plane me-1"></i>Send Invitations
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Custom Export Modal -->
<div class="modal fade" id="customExportModal" tabindex="-1" aria-labelledby="customExportModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="customExportModalLabel">Custom Export</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="customExportForm">
                    <div class="mb-3">
                        <label for="exportFormat" class="form-label">Export Format</label>
                        <select class="form-select" id="exportFormat">
                            <option value="json">JSON</option>
                            <option value="csv">CSV</option>
                            <option value="biom">BIOM</option>
                            <option value="excel">Excel</option>
                            <option value="fasta">FASTA</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Data to Include</label>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="includeProjectInfo" checked>
                            <label class="form-check-label" for="includeProjectInfo">
                                Project Information
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="includeSampleData" checked>
                            <label class="form-check-label" for="includeSampleData">
                                Sample Data
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="includeSequenceData">
                            <label class="form-check-label" for="includeSequenceData">
                                Raw Sequence Data
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="includeAnalysisData" checked>
                            <label class="form-check-label" for="includeAnalysisData">
                                Analysis Results
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="includeVisualizationData">
                            <label class="form-check-label" for="includeVisualizationData">
                                Visualization Data
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="includeCollaborationHistory">
                            <label class="form-check-label" for="includeCollaborationHistory">
                                Collaboration History
                            </label>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="exportSamples" class="form-label">Samples to Include</label>
                        <select class="form-select" id="exportSamples" multiple>
                            <option value="all" selected>All Samples</option>
                            {% for sample in project.samples %}
                            <option value="{{ sample.id }}">{{ sample.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="exportAnalyses" class="form-label">Analyses to Include</label>
                        <select class="form-select" id="exportAnalyses" multiple>
                            <option value="all" selected>All Analyses</option>
                            {% for analysis in project.analyses %}
                            <option value="{{ analysis.id }}">{{ analysis.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="startCustomExportBtn">
                    <i class="fas fa-download me-1"></i>Export
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Toggle visibility of expiration date input
        document.getElementById('linkExpiration').addEventListener('change', function() {
            document.getElementById('expirationDateContainer').style.display = this.checked ? 'block' : 'none';
        });
        
        // Toggle visibility of password input
        document.getElementById('requirePassword').addEventListener('change', function() {
            document.getElementById('passwordContainer').style.display = this.checked ? 'block' : 'none';
        });
        
        // Toggle visibility of publication details
        document.getElementById('isPublished').addEventListener('change', function() {
            document.getElementById('publicationDetailsContainer').style.display = this.checked ? 'block' : 'none';
        });
        
        // Copy share link to clipboard
        document.getElementById('copyLinkBtn').addEventListener('click', function() {
            const shareLink = document.getElementById('shareLink');
            shareLink.select();
            document.execCommand('copy');
            alert('Link copied to clipboard!');
        });
        
        // Copy citation to clipboard
        document.getElementById('copyCitationBtn').addEventListener('click', function() {
            const citationText = document.getElementById('citationText');
            citationText.select();
            document.execCommand('copy');
            alert('Citation copied to clipboard!');
        });
        
        // Project visibility radio buttons
        document.querySelectorAll('input[name="projectVisibility"]').forEach(function(radio) {
            radio.addEventListener('change', function() {
                // Update the visibility switch in the project info card
                const visibilitySwitch = document.getElementById('projectVisibilitySwitch');
                visibilitySwitch.checked = (this.id === 'visibilityPublic');
                visibilitySwitch.nextElementSibling.textContent = visibilitySwitch.checked ? 'Public' : 'Private';
            });
        });
        
        // Visibility switch in project info card
        document.getElementById('projectVisibilitySwitch').addEventListener('change', function() {
            // Update the visibility radio buttons
            if (this.checked) {
                document.getElementById('visibilityPublic').checked = true;
                this.nextElementSibling.textContent = 'Public';
            } else {
                document.getElementById('visibilityPrivate').checked = true;
                this.nextElementSibling.textContent = 'Private';
            }
        });
        
        // Save visibility settings
        document.getElementById('saveVisibilityBtn').addEventListener('click', function() {
            // This would be an AJAX call to save the visibility settings in a real application
            // For now, we'll just show a success message
            alert('Visibility settings saved successfully!');
        });
        
        // Generate new share link
        document.getElementById('generateNewLinkBtn').addEventListener('click', function() {
            // This would be an AJAX call to generate a new share link in a real application
            // For now, we'll just show a simulated new link
            const shareLink = document.getElementById('shareLink');
            const randomString = Math.random().toString(36).substring(2, 15);
            shareLink.value = `https://deepseaedna.org/share/${randomString}`;
            alert('New share link generated successfully!');
        });
        
        // Save link settings
        document.getElementById('saveLinkSettingsBtn').addEventListener('click', function() {
            // This would be an AJAX call to save the link settings in a real application
            // For now, we'll just show a success message
            alert('Link settings saved successfully!');
        });
        
        // Save publication info
        document.getElementById('savePublicationBtn').addEventListener('click', function() {
            // This would be an AJAX call to save the publication info in a real application
            // For now, we'll just show a success message
            alert('Publication information saved successfully!');
        });
        
        // Send invitations
        document.getElementById('sendInvitationsBtn').addEventListener('click', function() {
            // This would be an AJAX call to send invitations in a real application
            // For now, we'll just show a success message and close the modal
            alert('Invitations sent successfully!');
            $('#inviteCollaboratorsModal').modal('hide');
        });
        
        // Start custom export
        document.getElementById('startCustomExportBtn').addEventListener('click', function() {
            // This would be an AJAX call to start the custom export in a real application
            // For now, we'll just show a success message and close the modal
            alert('Export started! You will be notified when it is ready for download.');
            $('#customExportModal').modal('hide');
        });
        
        // Export activity log
        document.getElementById('exportActivityBtn').addEventListener('click', function() {
            // This would be an AJAX call to export the activity log in a real application
            // For now, we'll just show a success message
            alert('Activity log exported successfully!');
        });
        
        // Load more activity
        document.getElementById('loadMoreActivityBtn').addEventListener('click', function() {
            // This would be an AJAX call to load more activity in a real application
            // For now, we'll just show a loading state and then hide the button
            this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Loading...';
            this.disabled = true;
            
            // Simulate loading delay
            setTimeout(() => {
                this.style.display = 'none';
                alert('All activity loaded!');
            }, 1500);
        });
        
        // Search collaborators
        document.getElementById('searchCollaboratorBtn').addEventListener('click', function() {
            const searchTerm = document.getElementById('collaboratorSearch').value.toLowerCase();
            const collaboratorRows = document.querySelectorAll('tbody tr');
            
            collaboratorRows.forEach(row => {
                const collaboratorName = row.querySelector('.fw-bold').textContent.toLowerCase();
                const collaboratorInstitution = row.querySelector('.text-muted').textContent.toLowerCase();
                
                if (collaboratorName.includes(searchTerm) || collaboratorInstitution.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        });
        
        // Search contacts
        document.getElementById('contactSearch').addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            const contactItems = document.querySelectorAll('#contactsList .form-check');
            
            contactItems.forEach(item => {
                const contactName = item.querySelector('label div div:first-child').textContent.toLowerCase();
                const contactEmail = item.querySelector('small').textContent.toLowerCase();
                
                if (contactName.includes(searchTerm) || contactEmail.includes(searchTerm)) {
                    item.closest('.col-md-6').style.display = '';
                } else {
                    item.closest('.col-md-6').style.display = 'none';
                }
            });
        });
    });
</script>
{% endblock %}